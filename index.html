<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simba Express | Duka lako, jukumu letu.</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-pro.jpeg">
    <link rel="stylesheet" href="./dist/output.css">
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; scroll-behavior: smooth; }
        .hero-bg {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('favicon/Simba\ banner\ sample.jpeg');
            background-size: cover; background-position: center;
        }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .category-tab.active { border-color: #dc2626; color: #dc2626; background-color: #fef2f2; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Android-Friendly Scrollable Modal */
        .modal-content-scroll {
            max-height: 85vh; /* Prevents popup from being taller than the screen */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            width: 95%; /* More width on mobile */
            margin: auto;
        }

        /* Slimmer inputs for mobile thumb typing */
        input[type="tel"], input[type="text"] {
            font-size: 16px !important; /* Prevents iOS/Android auto-zoom on focus */
            padding: 12px !important;
        }

        /* Fixed Product Detail for Mobile */
        .product-modal-content {
            max-height: 90vh; /* Limits height to 90% of screen */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevents the whole box from scrolling */
        }

        .scrollable-content {
            overflow-y: auto; /* Only the image and text scroll */
            flex-grow: 1;
        }

        .fixed-bottom-actions {
            background: white;
            border-top: 1px solid #f3f4f6;
            padding: 1rem;
            z-index: 10;
        }

        /* Success Toast Notification */
        #success-toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #059669; /* Emerald Green */
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 50px;
            transform: translateX(-50%);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        #success-toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from { bottom: 0; opacity: 0; }
            to { bottom: 50px; opacity: 1; }
        }

        @keyframes fadeout {
            from { bottom: 50px; opacity: 1; }
            to { bottom: 0; opacity: 0; }
        }

        /* Hero Slider Styles */
        .hero-slider-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .hero-slider-item.hidden {
            display: none !important;
            opacity: 0;
        }

        .hero-slider-item.active {
            display: flex !important;
            opacity: 1;
        }

        /* Mobile responsive banner sizing */
        @media (max-width: 768px) {
            header {
                height: 300px !important;
            }
            .hero-slider-item {
                background-size: contain !important;
                background-repeat: no-repeat !important;
            }
        }
  
    </style>
</head>
<body class="bg-white text-gray-900">

   <nav class="fixed top-0 left-0 right-0 bg-white border-b z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between w-full">
            <div class="flex items-center">
                <img src="/favicon/simba_croped2_cropped.png" alt="Logo" class="h-10 w-auto">
            </div>
            <div class="flex items-center">
                <button id="user-icon-btn" onclick="toggleUserMenu()" class="hover:scale-110 transition-transform flex items-center justify-center w-11 h-11 rounded-full border-2 border-red-600" title="Akaunti Yako" style="color: #E60000; font-size: 24px;">
                    üë§
                </button>
            </div>
        </div>
   </nav>

    <header class="w-full h-[450px] lg:h-[650px] text-white text-center relative overflow-hidden mt-12">
        <!-- Slider Container -->
        <div class="relative w-full h-full">
            <div class="relative w-full h-full overflow-hidden">
                <!-- Slide 1 -->
                <div class="hero-slider-item active hero-bg w-full h-full flex flex-col items-center justify-center transition-opacity duration-500" style="background: url('favicon/simba-banner1.jpg?v=2'); background-size: cover; background-position: center;">
                </div>

                <!-- Slide 2 -->
                <div class="hero-slider-item hero-bg w-full h-full flex flex-col items-center justify-center transition-opacity duration-500 hidden" style="background: url('favicon/simba-banner2.jpg?v=2'); background-size: cover; background-position: center;">
                </div>

                <!-- Slider Indicators -->
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-3 z-10">
                    <button onclick="goToSlide(0)" class="slider-dot active w-4 h-4 rounded-full bg-white/70 hover:bg-white transition"></button>
                    <button onclick="goToSlide(1)" class="slider-dot w-4 h-4 rounded-full bg-white/70 hover:bg-white transition"></button>
                </div>
            </div>
        </div>
    </header>

    <div id="about-modal" class="modal" onclick="closePopup('about-modal')">
        <div class="bg-white p-8 max-w-md rounded-sm shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="text-red-600 text-3xl mb-4"></div>
            <h2 class="text-2xl font-black mb-4 uppercase tracking-tighter italic text-red-600">Sisi ni Akina Nani?</h2>
            <p class="text-gray-700 text-base mb-4 leading-relaxed">
                Simba Express tuko hapa kukusaidia Mjasiriamali wa Kitanzania. Tunajua changamoto za kufunga duka na kwenda sokoni kutafuta mzigo ni kupoteza muda na wateja.
            </p>
            <p class="text-gray-700 text-base mb-6 font-bold">
                Dhumuni letu ni moja tu: Wewe baki dukani uuze, sisi tutakuhangaikia mzigo ukufikie. Tunaleta bidhaa mpaka mlangoni kwako kwa bei ile ile ya soko. Hakuna usumbufu!
            </p>
            <button onclick="closePopup('about-modal')" class="w-full bg-black text-white py-3 text-xs font-bold uppercase tracking-widest hover:bg-red-600 transition">Nimeelewa, Turudi Kwenye Biashara</button>
        </div>
    </div>


    <div id="contact-modal" class="modal" onclick="closePopup('contact-modal')">
        <div class="bg-white p-8 max-w-md rounded-sm shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="text-green-600 text-3xl mb-4"></div>
            <h2 class="text-2xl font-black mb-4 uppercase tracking-tighter italic text-red-600">Wasiliana nasi</h2>
            <p class="text-gray-600 text-sm mb-6">
                Una swali au unataka oda maalum? Tupigie au tutumie ujumbe WhatsApp sasa hivi.
            </p>
            <div class="space-y-4 mb-8">
                <div class="flex items-center gap-4 border-b pb-3">
                    <span class="text-xl">üìç</span>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Ofisi Zetu</p>
                        <p class="font-bold text-sm text-gray-800">Mtaa wa Aggrey, Kariakoo, Dar es Salaam</p>
                    </div>
                </div>
               <div class="flex items-center gap-4 border-b pb-4 group">
                    <a href="https://wa.me/255685636220" target="_blank" class="text-2xl hover:scale-110 transition-transform cursor-pointer">
                        üü¢
                    </a>
                    
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">
                            Piga simu / WhatsApp
                        </p>
                        
                        <a href="tel:+255685636220" 
                        class="block font-black text-lg text-gray-800 hover:text-red-600 transition-colors active:opacity-60">
                            +255 685 636 220
                        </a>
                    </div>

                    <a href="tel:+255685636220" class="bg-red-600 text-white p-2 rounded-full shadow-md md:hidden">
                        üìû
                    </a>
               </div>
            </div>
            <button onclick="closePopup('contact-modal')" class="w-full bg-red-600 text-white py-3 text-xs font-bold uppercase tracking-widest hover:bg-red-700 transition">Nimeelewa, Turudi Kwenye Biashara</button>
        </div>
    </div>

    <!-- User Menu Dropdown -->
    <div id="user-menu" class="fixed top-20 right-6 bg-white border border-gray-200 rounded-lg shadow-2xl z-40 hidden w-64">
        <div id="user-menu-content">
            <!-- Content changes based on user state -->
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="register-modal" class="modal" onclick="closePopup('register-modal')">
        <div class="bg-white w-full max-w-md rounded-sm shadow-2xl modal-content-scroll relative" onclick="event.stopPropagation()">
            <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                <h2 class="text-lg font-black uppercase tracking-tighter italic text-red-600">Jisajili</h2>
                <button onclick="closePopup('register-modal')" class="text-gray-400 text-xl font-bold">‚úï</button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Jina Kamili</label>
                    <input type="text" id="reg-fullname" placeholder="Jina lako kamili" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Namba ya Simu</label>
                    <input type="tel" id="reg-phone" placeholder="255XXXXXXXXX" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Barua Pepe (Email)</label>
                    <input type="email" id="reg-email" placeholder="email@example.com" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Nenosiri</label>
                    <input type="password" id="reg-password" placeholder="Nenosiri salama" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Mahali (Eneo Lako)</label>
                    <input type="text" id="reg-location" placeholder="Jina la Mtaa/Jengo" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Picha ya Wasifu (Profile)</label>
                    <input type="file" id="reg-photo" accept="image/*" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Mahali (Coordinates)</label>
                    <button type="button" onclick="getLocation()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-sm text-xs font-black uppercase tracking-widest hover:bg-blue-700 transition">
                        üìç Pata Mahali Yangu
                    </button>
                    <input type="hidden" id="reg-latitude">
                    <input type="hidden" id="reg-longitude">
                    <p id="location-status" class="text-[10px] text-gray-400 mt-2 text-center"></p>
                </div>

                <button onclick="registerUser()" class="w-full bg-red-600 text-white py-4 rounded-sm font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition">
                    Jisajili Sasa
                </button>

                <p class="text-center text-xs text-gray-600 mt-4">
                    Una akaunti? <button onclick="switchToLogin()" class="text-red-600 font-bold hover:underline">Ingia</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" onclick="closePopup('login-modal')">
        <div class="bg-white w-full max-w-md rounded-sm shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-lg font-black uppercase tracking-tighter italic text-red-600">Ingia kwenye Akaunti</h2>
                <button onclick="closePopup('login-modal')" class="text-gray-400 text-xl font-bold">‚úï</button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Barua Pepe (Email)</label>
                    <input type="email" id="login-email" placeholder="email@example.com" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <div>
                    <label class="text-xs font-black uppercase tracking-widest text-gray-600 block mb-2">Nenosiri</label>
                    <input type="password" id="login-password" placeholder="Nenosiri yako" 
                        class="w-full border-2 border-gray-300 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                </div>

                <button onclick="loginUser()" class="w-full bg-red-600 text-white py-4 rounded-sm font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition">
                    Ingia
                </button>

                <p class="text-center text-xs text-gray-600 mt-4">
                    Huna akaunti? <button onclick="switchToRegister()" class="text-red-600 font-bold hover:underline">Jisajili</button>
                </p>
            </div>
        </div>
    </div>

    <section class="max-w-xl mx-auto -mt-12 bg-white border shadow-2xl p-6 relative z-10 text-center rounded-sm">
        <h4 class="text-[20px] text-black-900 font-bold uppercase tracking-widest mb-6">Jinsi Inavyofanya Kazi Huduma Yetu</h4>
       <div class="grid grid-cols-3 gap-2 mb-6 border-b pb-8 text-center">
            <div class="flex flex-col items-center">
                <p class="text-red-600 font-black text-lg">1</p>
                <div class="text-2xl my-1">
                    <p class="text-[10px] md:text-[12px] uppercase font-black leading-tight">Tembelea Ukurasa</p>
                    üõí</div> 
            </div>

            <div class="flex flex-col items-center">
                <p class="text-red-600 font-black text-lg">2</p>
                <div class="text-2xl my-1">
                    <p class="text-[10px] md:text-[12px] uppercase font-black leading-tight">Taka Bidhaa Yako</p>
                    üìã</div> 
            </div>

            <div class="flex flex-col items-center">
                <p class="text-red-600 font-black text-lg">3</p>
                <div class="text-2xl my-1">
                    <p class="text-[10px] md:text-[12px] uppercase font-black leading-tight">Upokee Haraka</p>
                    üì¶</div> 
            </div>
        </div>

<div class="mt-6 mb-8 text-center sm:text-left">
    <p class="text-xs font-black text-black-900 uppercase tracking-[0.2em] mb-2">
        Wasiliana na Huduma kwa Wateja:
    </p>
    
    <a href="tel:+255685636220" 
       class="inline-block text-3xl md:text-5xl font-black text-red-600 tracking-tighter hover:scale-105 transition-transform active:opacity-70">
        +255 685 636 220
    </a>

    <div class="flex items-center justify-center sm:justify-start gap-2 mt-2 text-blue-600 font-bold text-[10px] uppercase tracking-widest">
        <span class="animate-ping inline-flex h-2 w-2 rounded-full bg-blue-400 opacity-75"></span>
        Piga simu kwa huduma bora
    </div>
</div>        
    </section>

    <section class="container mx-auto mt-12 px-4 max-w-6xl">
        <!-- Categories Grid Only -->
        <div class="mb-16">
            <h2 class="text-3xl font-black text-gray-900 mb-12 text-center uppercase tracking-tighter">Chagua Kategoria</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Unga -->
                <div onclick="showCategoryProducts('unga')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üåæ</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Unga</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Unga na nafaka</p>
                </div>
                
                <!-- Vinywaji -->
                <div onclick="showCategoryProducts('vinywaji')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">ü•§</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Vinywaji</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Maji na soda</p>
                </div>
                
                <!-- Maji -->
                <div onclick="showCategoryProducts('maji')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üíß</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Maji</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Maji safi</p>
                </div>
                
                <!-- Pipi -->
                <div onclick="showCategoryProducts('pipi')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üç¨</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Pipi</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Pipi na keki</p>
                </div>
                
                <!-- Vyakula -->
                <div onclick="showCategoryProducts('vyakula')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üçú</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Vyakula</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Chakula kwa haraka</p>
                </div>
                
                <!-- Maziwa -->
                <div onclick="showCategoryProducts('maziwa')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">ü•õ</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Maziwa</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Maziwa na bidhaa</p>
                </div>
                
                <!-- Watoto -->
                <div onclick="showCategoryProducts('watoto')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üë∂</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Watoto</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Bidhaa za watoto</p>
                </div>
                
                <!-- Afya -->
                <div onclick="showCategoryProducts('afya')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üíä</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Afya</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Dawa na vitamini</p>
                </div>
                
                <!-- Steshenari -->
                <div onclick="showCategoryProducts('steshenari')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üìù</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Steshenari</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Karatasi na kalamu</p>
                </div>
                
                <!-- Usafi -->
                <div onclick="showCategoryProducts('usafi')" class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-red-600 hover:shadow-xl cursor-pointer transition-all transform hover:scale-105">
                    <div class="text-5xl mb-4 text-center">üßº</div>
                    <h3 class="text-lg font-black text-gray-900 text-center uppercase tracking-tight">Usafi</h3>
                    <p class="text-xs text-gray-600 text-center mt-2">Bidhaa za usafi</p>
                </div>
            </div>
        </div>

        <!-- Category Products Modal -->
        <div id="category-products-modal" class="modal" onclick="closeCategoryView()">
            <div class="bg-white w-full max-w-2xl rounded-lg shadow-2xl modal-content-scroll" onclick="event.stopPropagation()">
                <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center z-10">
                    <h2 id="category-title" class="text-2xl font-black uppercase tracking-tight"></h2>
                    <button onclick="closeCategoryView()" class="text-gray-400 text-2xl font-bold hover:text-gray-600">‚úï</button>
                </div>
                
                <div class="p-6">
                    <div class="relative mb-6">
                        <input type="text" id="category-search" onkeyup="filterCategoryProducts()" placeholder="Tafuta bidhaa..." 
                               class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-red-600 outline-none text-sm md:text-base">
                    </div>
                    
                    <div id="category-products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                </div>
            </div>
        </div>
    </section>
        
    </main>

    <section id="faq-section" class="bg-gray-50 py-16 mt-12 border-t border-b">
        <div class="max-w-2xl mx-auto px-4">
            <h3 class="text-2xl font-bold text-center mb-10 uppercase tracking-tighter">Maswali Yanayoulizwa Mara Kwa Mara</h3>
            <div class="space-y-4">
                <details class="bg-white p-5 border rounded-sm shadow-sm group">
                    <summary class="font-bold text-sm cursor-pointer list-none flex justify-between items-center uppercase tracking-tight">
                        Je, nitalipaje mzigo wangu? <span class="text-red-600 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <p class="text-gray-600 text-sm mt-4 leading-relaxed">Lipa Baada ya Kupokea: Hatupokei pesa kabla ya mzigo kufika. Ukikagua mzigo wako na kuridhika, ndipo unalipa kwa Cash au M-Pesa. Hakuna risk yoyote kwako.</p>
                </details>
                <details class="bg-white p-5 border rounded-sm shadow-sm group">
                    <summary class="font-bold text-sm cursor-pointer list-none flex justify-between items-center uppercase tracking-tight">
                        Nikipata mzigo tofauti na niliyoagiza inakuwaje? <span class="text-red-600 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <p class="text-gray-600 text-sm mt-4 leading-relaxed">Kagua Kwanza: Dereva akifika, fungua na kagua bidhaa zako. Ukiona kitu kimekosekana au kimeharibika, rudisha papo hapo bila gharama yoyote. Utalipia tu kile ulichokubali.</p>
                </details>
                <details class="bg-white p-5 border rounded-sm shadow-sm group">
                    <summary class="font-bold text-sm cursor-pointer list-none flex justify-between items-center uppercase tracking-tight">
                        Inachukua muda gani mzigo kufika? <span class="text-red-600 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <p class="text-gray-600 text-sm mt-4 leading-relaxed">Ndani ya Dakika 30-60: Tunajua biashara yako inategemea stock. Tukishathibitisha oda yako kupitia WhatsApp, dereva wetu anaanza safari mara moja. Hutahitaji kufunga duka kwenda sokoni.</p>
                </details>
                <details class="bg-white p-5 border rounded-sm shadow-sm group">
                    <summary class="font-bold text-sm cursor-pointer list-none flex justify-between items-center uppercase tracking-tight">
                        Sijui kutumia website, nitawezaje kuagiza? <span class="text-red-600 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <p class="text-gray-600 text-sm mt-4 leading-relaxed">Agiza kwa WhatsApp au Simu: Website yetu ni kama "catalog" ya kuona bei tu. Unaweza kutupigia simu moja kwa moja au kutuma picha ya bidhaa unazotaka kupitia WhatsApp. Tunafanya kazi rahisi kwako.</p>
                </details>
            </div>
        </div>
    </section>

    <section class="py-12 bg-white">
    <div class="container mx-auto px-4">
        <p class="text-[20px] text-center font-bold text-black uppercase tracking-widest mb-10">
            Chanzo rasmi cha bidhaa za uhakika kutoka kwa:
        </p>
        
        <div class="grid grid-cols-2 md:grid-cols-6 gap-8 md:gap-10 items-center justify-items-center">
            <img src="brands/azam.jpg" class="h-16 md:h-12 object-contain p-2" alt="Azam">
            <img src="brands/mo1.jpg" class="h-16 md:h-12 object-contain p-2" alt="Mo Dewji">
            <img src="brands/jambo.png" class="h-16 md:h-12 object-contain p-2" alt="Jambo">
            <img src="brands/cocacola.png" class="h-16 md:h-12 object-contain p-2" alt="Coca Cola">
            <img src="brands/pepsi.jpg" class="h-16 md:h-12 object-contain p-2" alt="Pepsi">
            <img src="brands/gsm.png" class="h-16 md:h-12 object-contain p-2" alt="GSM">
        </div>
        
        <p class="text-center text-[15px] font-bold text-black mt-10 italic uppercase">
            Bidhaa zote za jumla kwa bei halisi ya sokoni.
        </p>
    </div>
</section>

    <div id="cart-trigger" class="fixed bottom-6 right-6 hidden z-40">
        <button onclick="openPopup('cart-modal')" class="bg-red-600 text-white px-8 py-4 rounded-full shadow-2xl font-bold flex items-center gap-3 hover:scale-105 transition transform">
            <span class="uppercase text-xs tracking-widest">Tazama Oda</span>
            <span id="cart-count" class="bg-white text-red-600 px-2 rounded-full text-xs">0</span>
        </button>
    </div>

   <div id="product-modal" class="modal">
    <div class="bg-white w-full max-w-md rounded-sm overflow-hidden relative shadow-2xl">
        
        <div class="w-full h-64 bg-gray-100 flex items-center justify-center p-4">
            <img id="modal-img" src="" 
                 class="max-w-full max-h-full object-contain" 
                 alt="Product Preview">
        </div>

        <div class="p-6 md:p-8">
            <div id="modal-id" class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1"></div>
            <h2 id="modal-name" class="text-2xl font-black mb-2 text-gray-900 leading-tight"></h2>
            <p id="modal-price" class="text-red-600 font-black text-3xl mb-4"></p>
            <p id="modal-desc" class="text-gray-500 text-sm mb-8 leading-relaxed border-l-4 border-red-600 pl-4"></p>
            
            <div class="flex flex-col gap-4 border-t pt-6">
                <div class="flex flex-col md:flex-row items-center md:justify-between w-full gap-4">
                    
                    <div class="flex items-center border-2 border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <button onclick="changeQty(-1)" 
                                class="px-4 py-3 bg-gray-100 active:bg-gray-300 text-lg font-black transition-colors border-r-2 border-gray-200">
                            ‚àí
                        </button>
                        
                        <span id="modal-qty" class="px-6 py-3 font-black text-xl min-w-[60px] text-center bg-white">
                            0
                        </span>
                        
                        <button onclick="changeQty(1)" 
                                class="px-4 py-3 bg-red-50 text-red-600 active:bg-red-200 text-lg font-black transition-colors">
                            +
                        </button>
                    </div>

                    <button onclick="confirmAddToCart()" 
                            class="bg-red-600 text-white px-6 py-4 font-black rounded-lg uppercase text-[11px] tracking-widest shadow-xl active:scale-95 transition-all w-full md:w-auto">
                        Agiza Sasa
                    </button>
                </div>
            </div>
        </div>
        
        <button onclick="closePopup('product-modal')" 
                class="absolute top-4 right-4 bg-white text-gray-900 w-12 h-12 rounded-full shadow-xl font-black flex items-center justify-center border-2 border-gray-100 active:bg-red-600 active:text-white transition">
            ‚úï
        </button>
    </div>
</div>

    <div id="cart-modal" class="modal">
      <div class="bg-white w-full max-w-sm mx-auto rounded-sm shadow-2xl modal-content-scroll">
        <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
            <h2 class="text-lg font-black uppercase tracking-tighter italic text-red-600">Muhtasari wa Oda Yako</h2>
            <button onclick="closePopup('cart-modal')" class="text-gray-400 text-xl font-bold">‚úï</button>
        </div>

        <div id="cart-items" class="p-6 space-y-4 overflow-y-auto flex-grow" style="max-height: 200px;">
            </div>

        <div class="p-6 border-t bg-gray-50">
            <div id="cart-checkout-content">
                <!-- Content changes based on user login state -->
            </div>
        </div>
    </div>
</div> 

    <!-- Success Toast Notification -->
     <div id="success-toast">‚úÖ Oda Imepokelewa! Asante.</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // Replace these with your own Supabase URL and API Key
        const SUPABASE_URL = 'https://cmsqvcqddnefquxzchxy.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_-gvIarUYmwzVVMv2jQiotQ_IM2PVtKg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentUser = null;
        
        const products = [
         
            /* Nafaka na Chakula */

            { id: "AS-01", brand: "Asas", name: "Maziwa ya Asas", price: 16000, category: "Maziwa", desc: "Boxi la Maziwa ya Asas.", img: "grain/ASAS_MILK-removebg.png" },
            { id: "Az-011", brand: "Azam", name: "Nazi ya Azam", price: 30000, category: "Vyakula", desc: "Boxi ya Nazi ya Azam", img: "grain/AZAM_COCONUT_CREAM-removebg.png" },
            { id: "Az-012", brand: "Azam", name: "Bisuit za Azam", price: 15000, category: "Vyakula", desc: "Boxi la Biscuit za Azam", img: "grain/AZAM-MARIE-GINGER-removebg.png" },
            { id: "Az-013", brand: "Azam", name: "Unga wa PPf", price: 21500, category: "Unga", desc: "Unga wa PPF - 1", img: "grain/Azam-PPF-1.png" },
            { id: "Kr-10", brand: "Korie", name: "Mafuta ya Korie", price: 29500, category: "Vyakula", desc: "Mafuta ya kula ya lita 1", img: "grain/Korie Cooking Oil 900Ml.webp" },
            { id: "Kr-11", brand: "Korie", name: "Mafuta ya Korie", price: 39000, category: "Vyakula", desc: "Mafuta ya kula ya lita 20", img: "grain/Korie Cooking.webp" },
            { id: "S-10", brand: "Singida", name: "Mafuta ya Kula", price: 30900, category: "Vyakula", desc: "Mafuta ya kula ya lita 5", img: "grain/SINGIDA_COOKING_OIL-removebg.png" },
            { id: "Mo-10", brand: "Mo", name: "Tambi za Mo", price: 23000, category: "Vyakula", desc: "Boxi La Tambi za Mo", img: "grain/mospagheti-removebg.png" },
            { id: "Rg-10", brand: "Redgold", name: "Redgold Tomato Sauce", price: 16000, category: "Vyakula", desc: "Boxi la Redgold Tomato Sauce", img: "grain/tomatopaste70g-removebg.png" },
            { id: "Rg-11", brand: "Redgold", name: "Redgold Tomato Paste", price: 13500, category: "Vyakula", desc: "Boxi la Redgold Tomato Paste", img: "grain/redgold-tomato-removebg.png" },
            { id: "S-11", brand: "Singida", name: "Mafuta ya Kula Lite", price: 15000, category: "Vyakula", desc: "Mafuta ya kula ya lita 5", img: "oil/SINGIDA COOKING OIL.jpg" },
            { id: "S-12", brand: "Singida", name: "Mafuta ya Kula Pro", price: 15000, category: "Vyakula", desc: "Mafuta ya kula ya lita 5", img: "oil/SINGIDA COOKING OIL.jpg" },
            { id: "S-13", brand: "Singida", name: "Mafuta ya Kula Plus", price: 15000, category: "Vyakula", desc: "Mafuta ya kula ya lita 5", img: "oil/SINGIDA COOKING OIL.jpg" },
            { id: "S-14", brand: "Singida", name: "Mafuta ya Kula Premium", price: 15000, category: "Vyakula", desc: "Mafuta ya kula ya lita 5", img: "oil/SINGIDA COOKING OIL.jpg" },

                
           
            /* Vinywaji */

            { id: "MO-01", brand: "METL", name: "Mo Cola", price: 4700, category: "Vinywaji", desc: "Katoni ya Soda ya Mo Cola. Ujazo 300Ml. Idadi 12", img: "drinks/mocola-1-removebg-preview.png" },
            { id: "MO-02", brand: "METL", name: "Mo xtra", price: 4800, category: "Vinywaji", desc: "Katoni ya Energy drink ya Mo. Ujazo 300Ml. Idadi 12", img: "drinks/moextra1-removebg.png" },
            { id: "MO-03", brand: "METL", name: "Mo Chungwa", price: 4600, category: "Vinywaji", desc: "Katoni ya Juisi ya Mo Chungwa. Ujazo 300Ml. Idadi 12", img: "drinks/moorange-removebg.png" },
            { id: "MO-04", brand: "METL", name: "Mo Passion", price: 4800, category: "Vinywaji", desc: "Katoni ya Juisi ya Mo Passion. Ujazo 300Ml. Idadi 12", img: "drinks/mopassion-removebg.png" },
            { id: "Az-01", brand: "Azam", name: "Azam Cola", price: 9400, category: "Pipi", desc: "Azam Cola - Soda drink. Ujazo 300Ml. Idadi 12", img: "drinks/AZAM-COLA-CROPPED.png" },
            { id: "Az-02", brand: "Azam", name: "Azam Energy", price: 11950, category: "Vinywaji", desc: "Katoni ya Juisi ya Azam Energy. Ujazo 300Ml. Idadi 12", img: "drinks/azam_energy-removebg.png" },
            { id: "Az-03", brand: "Azam", name: "Azam Apple Punch", price: 9500, category: "Vinywaji", desc: "Katoni ya juisi ya Apple Punch. Ujazo 300Ml. Idadi 12", img: "drinks/Azam-Apple-Punch-300ml-removebg.png" },
            { id: "Az-04", brand: "Azam", name: "Azam Embe", price: 10700, category: "Vinywaji", desc: "Katoni ya juisi ya Azam Embe. Ujazo 300Ml. Idadi 12", img: "drinks/Azam-Mango-1Litre-removebg.png" },
            { id: "Az-05", brand: "Azam", name: "Azam Max", price: 9500, category: "Vinywaji", desc: "Katoni ya juisi ya Azam Max. Ujazo 300Ml. Idadi 12", img: "drinks/AZAM-MAX2.png" },
            { id: "Az-06", brand: "Azam", name: "Azam Swiss", price: 9500, category: "Vinywaji", desc: "Katoni ya juisi ya Azam Swiss. Ujazo 300Ml. Idadi 12", img: "drinks/Swiss-New-removebg.png" },
            { id: "AF-01", brand: "Afia", name: "Afiya Strawberry", price: 4600, category: "Vinywaji", desc: "Katoni ya juisi ya Afiya Nyeusi. Ujazo 300Ml. Idadi 12", img: "drinks/afyablack-removebg.png" },
            { id: "AF-02", brand: "Afiya", name: "Afiya Orange", price: 4600, category: "Vinywaji", desc: "Katoni ya juisi ya Afiya Orange. Ujazo 300Ml. Idadi 12", img: "drinks/afyaorange-removebg.png" },
            { id: "AF-03", brand: "Afiya", name: "Afiya Passion", price: 4600, category: "Vinywaji", desc: "Katoni ya juisi ya Afiya Passion. Ujazo 300Ml. Idadi 12", img: "drinks/afyapasion-removebg.png" },
            { id: "AF-04", brand: "Afiya", name: "Afiya Malta", price: 4600, category: "Vinywaji", desc: "Katoni ya juisi ya Afiya Malta. Ujazo 300Ml. Idadi 12", img: "drinks/afyamalta-removebg.png" },
            { id: "AF-05", brand: "Afiya", name: "Afiya Pineapple", price: 4600, category: "Vinywaji", desc: "Katoni ya juisi ya Afiya Pineapple. Ujazo 300Ml. Idadi 12", img: "drinks/afiyapineapple-removebg.png" },
            
            /* Mengineyo */

            { id: "SH-09", brand: "Shwari", name: "Shwari Toilet Paper", price: 10000, category: "Usafi", desc: "Box la toilet paper za shwari.", img: "other/SHWARI_TOILET_PAPER-removebg.png" },
            { id: "Mo-01", brand: "Mo", name: "Mo Taifa Blue", price: 10000, category: "Usafi", desc: "Box la Sabuni za Mo za Unga.", img: "other/motaifablue-removebg.png" },
            { id: "Mo-02", brand: "Mo", name: "Mo Taifa Yellow", price: 10000, category: "Usafi", desc: "Box la Sabuni za Mo za Unga.", img: "other/motaifayellow-removebg.png" },
            { id: "Mo-03", brand: "Mo", name: "Mo Halisi Red", price: 10000, category: "Usafi", desc: "Box la Sabuni za Mo za Unga.", img: "other/mohalisi1-removebg.png" },
            { id: "Mo-04", brand: "Mo", name: "Mo soap", price: 10000, category: "Usafi", desc: "Box la sabuni ya Kuogea.", img: "other/mosoap-removebg.png" },
            { id: "SF-01", brand: "Softcare", name: "Softcare Diaper", price: 10000, category: "Watoto", desc: "Box la Softcare Diapersi.", img: "other/SOFTCARE_DIAPERS-removebg.png" },
            { id: "SF-09", brand: "Softcare", name: "Softcare Pads", price: 34000, category: "Afya", desc: "Box la Softcare Pads.", img: "other/SOFTCARE_PADS-removebg.png" },
            { id: "Mk-01", brand: "Mk", name: "Mosquito King", price: 20650, category: "Usafi", desc: "Box la dawa ya Mbu.", img: "other/dawayambuuu-removebg.png" },
            { id: "Df-01", brand: "Doffi", name: "Doffi Yellow", price: 9850, category: "Usafi", desc: "Box la Doffi Yellow.", img: "other/doffiyellow-removebg.png" },
            { id: "Df-02", brand: "Doffi", name: "Doffi Pink", price: 9850, category: "Usafi", desc: "Box la Doffi Pink", img: "other/doffipink-removebg.png" },
            { id: "Ks-09", brand: "Kleesoft", name: "Sabuni Ya Kleesoft", price: 4150, category: "Usafi", desc: "Box la Sabuni ya Kleesoft.", img: "other/Kleesoft-removebg.png" },
            { id: "Nc-09", brand: "Niceone", name: "Sabuni Ya Niceone", price: 9700, category: "Usafi", desc: "Box la Sabuni ya Niceone.", img: "other/niceone-removebg.png" },
            { id: "An-01", brand: "Azania", name: "Sabuni ya Marhaba", price: 4300, category: "Usafi", desc: "Box la Sabuni ya Marhaba.", img: "other/Marhaba-removebg.png" },
            { id: "Vv-01", brand: "Viva", name: "Viva Tissue Paper", price: 10000, category: "Usafi", desc: "Box la Tissue paper za Viva.", img: "other/vivasoft-removebg.png" },
            { id: "Jm-01", brand: "Jamaa", name: "Sabuni ya Jamaa", price: 15150, category: "Usafi", desc: "Box la Miche ya Jamaa.", img: "other/sabuniyajamaa-removebg.png" },

        ];

        // ============================================
        // LOAD PRODUCTS FROM SUPABASE (FALLBACK TO LOCAL)
        // ============================================
        
        // Storage bucket for product images
        const STORAGE_BUCKET = 'Web%20Products'; // URL encoded "Web Products"
        
        // Function to construct Supabase image URLs
        function getSupabaseImageUrl(localImagePath) {
            // Convert local path (e.g., "drinks/mocola.png") to full Supabase URL
            return `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${localImagePath}`;
        }
        
        async function loadProductsFromSupabase() {
            try {
                console.log('üì¶ Loading products from Supabase database...');
                
                // First check if we can connect
                console.log('üîå Checking Supabase connection...');
                const { data: testData, error: testError } = await supabaseClient
                    .from('products')
                    .select('id')
                    .limit(1);
                
                if (testError) {
                    console.error('‚ùå Supabase connection error:', testError);
                    console.warn('‚ö†Ô∏è Using local products instead');
                    return false;
                }
                
                // Now fetch all products
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Query error:', error.message);
                    console.warn('‚ö†Ô∏è Using local products instead');
                    return false;
                }
                
                if (!data) {
                    console.error('‚ùå No data returned from query');
                    return false;
                }
                
                console.log('üìä Raw data from Supabase:', data);
                console.log('üî¢ Product count:', data.length);
                
                if (data.length === 0) {
                    console.warn('‚ö†Ô∏è No products in database, using local products');
                    return false;
                }
                
                // Clear and replace with database products
                products.length = 0;
                
                data.forEach(product => {
                    // Determine image URL: use image_url if available, otherwise construct from img field
                    let imageUrl = product.image_url || '';
                    
                    // If image_url is not a full URL, assume it's a relative path and convert it
                    if (imageUrl && !imageUrl.startsWith('http')) {
                        imageUrl = getSupabaseImageUrl(imageUrl);
                    } else if (!imageUrl && product.img) {
                        // Fallback to img field if image_url is empty
                        imageUrl = product.img.startsWith('http') ? product.img : getSupabaseImageUrl(product.img);
                    }
                    
                    products.push({
                        id: product.id,
                        brand: product.brand || '',
                        name: product.name,
                        price: product.price,
                        category: product.category,
                        desc: product.desc || '',
                        img: imageUrl
                    });
                });
                
                console.log('‚úÖ Loaded', products.length, 'products from Supabase');
                const categories = [...new Set(products.map(p => p.category))];
                console.log('Categories:', categories);
                
                // Debug: Show all products
                console.log('üìã All Products:');
                products.forEach(p => {
                    console.log(`  - ${p.name} (${p.category}) - ${p.brand}`);
                });
                
                // Debug: Look for water products
                const waterProducts = products.filter(p => p.name.toLowerCase().includes('water') || p.name.toLowerCase().includes('maji') || p.category.toLowerCase().includes('maji'));
                if (waterProducts.length > 0) {
                    console.log('üíß Water Products Found:', waterProducts);
                } else {
                    console.warn('‚ö†Ô∏è No water products found!');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Fatal error loading products:', error.message);
                console.error('Stack:', error);
                return false;
            }
        }

        let cart = [];
        let currentProduct = null;
        let currentQty = 1;
        let expandedSections = { nafaka: false, vinywaji: false, mengineyo: false };

        // ============================================
        // USER AUTHENTICATION FUNCTIONS
        // ============================================

        // Check if user is already logged in
        async function checkUserSession() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session?.user) {
                    currentUser = session.user;
                    await loadUserProfile();
                    updateUserUI();
                } else {
                    showLoginUI();
                }
            } catch (error) {
                console.log('No session found:', error);
                showLoginUI();
            }
        }

        // Load user profile picture and details
        async function loadUserProfile() {
            try {
                console.log('Loading profile for user:', currentUser.id);
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.warn('Profile not loaded:', error);
                    return;
                }

                if (data) {
                    console.log('Profile loaded:', data);
                    currentUser.profile = data;
                    
                    // Update navbar with profile picture if available
                    if (data.profile_picture_url) {
                        console.log('Updating navbar with profile picture:', data.profile_picture_url);
                        const userBtn = document.getElementById('user-icon-btn');
                        if (userBtn) {
                            userBtn.innerHTML = `<img src="${data.profile_picture_url}" class="w-8 h-8 rounded-full object-cover border-2 border-red-600" alt="Profile">`;
                            userBtn.style.padding = '0';
                            console.log('‚úÖ Profile picture updated in navbar');
                        }
                    } else {
                        console.log('No profile picture URL found');
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const userBtn = document.getElementById('user-icon-btn');
            const userMenu = document.getElementById('user-menu');
            if (!userBtn.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // Show login/register options
        function showLoginUI() {
            const menuContent = document.getElementById('user-menu-content');
            menuContent.innerHTML = `
                <div class="p-4 space-y-3">
                    <p class="text-xs text-gray-600 font-bold uppercase tracking-widest mb-4 text-center">Karibu</p>
                    <button onclick="openPopup('login-modal')" class="w-full bg-red-600 text-white py-3 rounded-sm font-black uppercase tracking-widest text-xs hover:bg-red-700 transition">
                        Ingia
                    </button>
                    <button onclick="openPopup('register-modal')" class="w-full bg-gray-200 text-gray-900 py-3 rounded-sm font-black uppercase tracking-widest text-xs hover:bg-gray-300 transition">
                        Jisajili
                    </button>
                </div>
            `;
        }

        // Update UI after successful login
        function updateUserUI() {
            const menuContent = document.getElementById('user-menu-content');
            const userEmail = currentUser?.email || 'User';
            const profilePic = currentUser?.profile?.profile_picture_url;
            
            let profileImageHtml = '';
            if (profilePic) {
                profileImageHtml = `<img src="${profilePic}" class="w-12 h-12 rounded-full object-cover border-2 border-red-600 mx-auto mb-2" alt="Profile">`;
            }
            
            menuContent.innerHTML = `
                <div class="p-4 space-y-3">
                    ${profileImageHtml}
                    <p class="text-xs text-gray-600 font-bold uppercase tracking-widest mb-2 text-center">Karibu,</p>
                    <p class="text-sm font-bold text-gray-900 text-center truncate">${userEmail}</p>
                    <button onclick="viewUserProfile()" class="w-full bg-blue-600 text-white py-2 rounded-sm font-black uppercase tracking-widest text-xs hover:bg-blue-700 transition">
                        üë§ Wasifu
                    </button>
                    <button onclick="logoutUser()" class="w-full bg-gray-200 text-gray-900 py-2 rounded-sm font-black uppercase tracking-widest text-xs hover:bg-gray-300 transition">
                        Toka
                    </button>
                </div>
            `;
            
            // Also update navbar button if profile picture exists
            if (profilePic) {
                const userBtn = document.getElementById('user-icon-btn');
                if (userBtn) {
                    userBtn.innerHTML = `<img src="${profilePic}" class="w-8 h-8 rounded-full object-cover border-2 border-red-600" alt="Profile">`;
                    userBtn.style.padding = '0';
                }
            }
        }

        // Switch to login modal
        function switchToLogin() {
            closePopup('register-modal');
            openPopup('login-modal');
        }

        // Switch to register modal
        function switchToRegister() {
            closePopup('login-modal');
            openPopup('register-modal');
        }

        // Register user
        async function registerUser() {
            const fullname = document.getElementById('reg-fullname').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const location = document.getElementById('reg-location').value;
            const latitude = document.getElementById('reg-latitude').value;
            const longitude = document.getElementById('reg-longitude').value;
            const photoFile = document.getElementById('reg-photo').files[0];

            if (!fullname || !phone || !email || !password || !location) {
                alert('Tafadhali jaza sehemu zote!');
                return;
            }

            try {
                // Register user with Supabase Auth
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    alert('Hitilafu: ' + error.message);
                    return;
                }

                // Upload profile picture if provided
                let profilePictureUrl = null;
                if (photoFile) {
                    try {
                        console.log('Starting photo upload...');
                        const fileName = `${data.user.id}-${Date.now()}.jpg`;
                        
                        const { data: uploadData, error: uploadError } = await supabaseClient.storage
                            .from('profile_pictures')
                            .upload(fileName, photoFile);

                        if (uploadError) {
                            console.warn('Photo upload error:', uploadError);
                            // Continue without photo
                        } else {
                            console.log('Photo uploaded:', uploadData);
                            const { data: urlData } = supabaseClient.storage
                                .from('profile_pictures')
                                .getPublicUrl(fileName);
                            profilePictureUrl = urlData.publicUrl;
                            console.log('Public URL generated:', profilePictureUrl);
                        }
                    } catch (photoError) {
                        console.warn('Photo upload issue:', photoError);
                    }
                }

                // Save user profile to database
                const { error: dbError } = await supabaseClient
                    .from('user_profiles')
                    .insert([{
                        user_id: data.user.id,
                        fullname: fullname,
                        phone: phone,
                        email: email,
                        location: location,
                        latitude: latitude || null,
                        longitude: longitude || null,
                        profile_picture_url: profilePictureUrl,
                        created_at: new Date()
                    }]);

                if (dbError) {
                    console.error('Database error details:', {
                        message: dbError.message,
                        details: dbError.details,
                        hint: dbError.hint,
                        code: dbError.code
                    });
                    
                    // Show detailed error to help debugging
                    let errorMsg = 'Kosa katika kuhifadhi habari.\n\n';
                    if (dbError.code === 'PGRST116') {
                        errorMsg += 'Hitilafu: Jedwali user_profiles halijaumbuawa.\n\nTafadhali wasiliana na msaada.';
                    } else if (dbError.message.includes('duplicate')) {
                        errorMsg += 'Hitilafu: Barua pepe hii tayari imejisajili.\n\nJaribu kwa barua pepe nyingine.';
                    } else if (dbError.message.includes('foreign key')) {
                        errorMsg += 'Hitilafu: Tatizo la data integrity.\n\nTafadhali jaribu tena.';
                    } else {
                        errorMsg += dbError.message || 'Unknown error';
                    }
                    
                    alert(errorMsg);
                    console.error('Full error object:', dbError);
                    return;
                }

                alert('Mjumbe akusanywa kwa mafanikio! Tafadhali kagua barua pepe yako kwa ujumbe wa kubaini.');
                
                // Clear form
                document.getElementById('reg-fullname').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-password').value = '';
                document.getElementById('reg-location').value = '';
                document.getElementById('reg-latitude').value = '';
                document.getElementById('reg-longitude').value = '';
                document.getElementById('reg-photo').value = '';
                document.getElementById('location-status').textContent = '';
                
                closePopup('register-modal');
                openPopup('login-modal');
            } catch (error) {
                console.error('Registration error:', error);
                alert('Kosa katika usajili: ' + error.message);
            }
        }

        // Login user
        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Tafadhali jaza barua pepe na nenosiri!');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    alert('Hitilafu: ' + error.message);
                    return;
                }

                currentUser = data.user;
                await loadUserProfile();
                updateUserUI();
                
                // Clear form
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                
                closePopup('login-modal');
                document.getElementById('user-menu').classList.add('hidden');
                
                alert('Umeingia kwa mafanikio!');
            } catch (error) {
                console.error('Login error:', error);
                alert('Kosa katika kuingia: ' + error.message);
            }
        }

        // Logout user
        async function logoutUser() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    alert('Hitilafu: ' + error.message);
                    return;
                }

                currentUser = null;
                showLoginUI();
                document.getElementById('user-menu').classList.add('hidden');
                alert('Umefungua akaunti yako.');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Kosa katika kufunga akaunti: ' + error.message);
            }
        }

        // View user profile (future feature)
        function viewUserProfile() {
            alert('Sehemu ya wasifu itakuja hivi karibuni!');
        }

        // Get user's live location
        function getLocation() {
            const statusEl = document.getElementById('location-status');
            
            if (!navigator.geolocation) {
                statusEl.textContent = '‚ùå Simu yako haisupporti mahali.';
                return;
            }

            statusEl.textContent = 'üìç Inakutafuta...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    document.getElementById('reg-latitude').value = lat;
                    document.getElementById('reg-longitude').value = lng;
                    statusEl.textContent = `‚úÖ Mahali pimwa: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                },
                (error) => {
                    statusEl.textContent = `‚ùå ${error.message}`;
                }
            );
        }

function renderGrid(data) {
    // Store current data globally so buttons can access it
    window.lastRenderedData = data;

    const grids = {
        nafaka: document.getElementById('product-list-nafaka'),
        vinywaji: document.getElementById('product-list-vinywaji'),
        mengineyo: document.getElementById('product-list-mengineyo')
    };
    const noRes = document.getElementById('no-results');
    
    Object.values(grids).forEach(g => { if(g) g.innerHTML = ''; });
    
    if (!data || data.length === 0) {
        if (noRes) noRes.classList.remove('hidden');
        return;
    } 
    if (noRes) noRes.classList.add('hidden');

    const limit = window.innerWidth < 768 ? 6 : 10;

    const categorized = {
        nafaka: data.filter(p => ['Grains', 'Oils', 'Pasta', 'Nafaka'].includes(p.category)),
        vinywaji: data.filter(p => ['Drinks', 'Vinywaji', 'Soda'].includes(p.category)),
        mengineyo: data.filter(p => !['Grains', 'Oils', 'Pasta', 'Nafaka', 'Drinks', 'Vinywaji', 'Soda'].includes(p.category))
    };

    Object.keys(categorized).forEach(key => {
        const list = categorized[key];
        const grid = grids[key];
        const btn = document.getElementById(`btn-${key}`);
        
        if (!grid) return;

        const isExpanded = expandedSections[key];
        const itemsToShow = isExpanded ? list : list.slice(0, limit);

        itemsToShow.forEach(p => {
            grid.innerHTML += `
                <div class="border border-gray-200 rounded-sm hover:shadow-lg transition-all cursor-pointer flex flex-col group bg-white" onclick="openProduct('${p.id}')">
                    <div class="w-full h-48 bg-gray-50 flex items-center justify-center overflow-hidden p-2 relative">
                        <img src="${p.img}" onerror="this.src='https://via.placeholder.com/400?text=Product'" class="max-w-full max-h-full object-contain group-hover:scale-105 transition duration-300">
                        <span class="absolute top-2 left-2 bg-white/90 text-black text-[9px] px-2 py-0.5 font-bold rounded shadow-sm border border-gray-100 uppercase tracking-tighter">ID: ${p.id}</span>
                    </div>
                    <div class="p-3 border-t border-gray-50">
                        <p class="text-[10px] font-bold text-blue-600 uppercase tracking-tight mb-0.5">${p.brand || 'SIMBA'}</p>
                        <h4 class="font-bold text-gray-900 text-sm leading-tight h-10 line-clamp-2">${p.name}</h4>
                        <div class="mt-2 flex items-center justify-between">
                            <p class="text-red-600 font-extrabold text-sm">Tsh ${p.price.toLocaleString()}</p>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">${p.category}</span>
                        </div>
                    </div>
                </div>`;
        });

        // 5. REMODELED BUTTON LOGIC
        if (btn) {
            // Only show button if the list is longer than the limit
            if (list.length > limit) {
                btn.classList.remove('hidden');
                if (isExpanded) {
                    btn.innerText = "Tazama Chache";
                    btn.setAttribute("onclick", `collapseSection('${key}')`);
                    btn.classList.replace('bg-gray-100', 'bg-gray-800'); // Darker when expanded
                    btn.classList.replace('text-gray-800', 'text-white');
                } else {
                    btn.innerText = "Tazama Zaidi";
                    btn.setAttribute("onclick", `expandSection('${key}')`);
                    btn.classList.replace('bg-gray-800', 'bg-gray-100');
                    btn.classList.replace('text-white', 'text-gray-800');
                }
            } else {
                btn.classList.add('hidden');
            }
        }
        
        grid.parentElement.style.display = list.length === 0 ? 'none' : 'block';
    });
}

// Function to Expand
function expandSection(key) {
    expandedSections[key] = true;
    renderGrid(window.lastRenderedData);
}

// Function to Collapse (Tazama Chache)
function collapseSection(key) {
    expandedSections[key] = false;
    renderGrid(window.lastRenderedData);
    
    // Scroll back to the section header so the user isn't lost
    document.getElementById(`btn-${key}`).parentElement.scrollIntoView({ behavior: 'smooth' });
}
        function filterProducts() {
            const query = document.getElementById('product-search').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(query) || p.brand.toLowerCase().includes(query) || p.id.toLowerCase().includes(query)
            );
            renderGrid(filtered);
        }

        function filterByCategory(cat) {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.toggle('active', t.innerText.toLowerCase() === cat.toLowerCase()));
            const filtered = cat === 'All' ? products : products.filter(p => p.category === cat);
            renderGrid(filtered);
        }

        // Category Functions
        let currentCategoryFilter = '';

        function showCategoryProducts(category) {
            console.log('üîµ showCategoryProducts called with:', category);
            currentCategoryFilter = category;
            const modal = document.getElementById('category-products-modal');
            const grid = document.getElementById('category-products-grid');
            const titleEl = document.getElementById('category-title');
            const searchInput = document.getElementById('category-search');
            
            console.log('üîµ Modal element exists:', !!modal);
            console.log('üîµ Grid element exists:', !!grid);
            
            if (titleEl) titleEl.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            if (searchInput) searchInput.value = '';
            
            // Map category names to exact product categories (using Swahili names)
            const categoryMap = {
                'unga': ['Unga'],
                'vinywaji': ['Vinywaji'],
                'maji': ['Maji'],
                'pipi': ['Pipi'],
                'vyakula': ['Vyakula'],
                'maziwa': ['Maziwa'],
                'watoto': ['Watoto'],
                'afya': ['Afya'],
                'steshenari': ['Steshenari'],
                'usafi': ['Usafi']
            };
            
            const productCategories = categoryMap[category] || [];
            console.log('üîµ Looking for categories:', productCategories);
            console.log('üîµ Total products in array:', products.length);
            console.log('üîµ All product categories:', [...new Set(products.map(p => p.category))]);
            
            let filtered = [];
            
            if (productCategories.length > 0) {
                filtered = products.filter(p => productCategories.includes(p.category));
            }
            
            console.log('üîµ Filtered products found:', filtered.length);
            
            grid.innerHTML = '';
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400 font-bold uppercase text-sm">Hakuna bidhaa.</div>';
                console.log('üîµ No products to display');
            } else {
                filtered.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'border border-gray-200 rounded-lg p-3 bg-white cursor-pointer hover:shadow-lg transition-shadow';
                    card.onclick = () => openProduct(product.id);
                    card.innerHTML = `
                        <img src="${product.img}" alt="${product.name}" class="w-full h-32 object-contain rounded mb-2 bg-gray-50" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        <h3 class="text-xs font-bold text-gray-900 line-clamp-1">${product.name}</h3>
                        <p class="text-[10px] text-gray-600 mb-2">${product.brand}</p>
                        <p class="text-red-600 font-black text-sm">TSH ${product.price.toLocaleString()}</p>
                    `;
                    grid.appendChild(card);
                });
                console.log('üîµ Added', filtered.length, 'products to grid');
            }
            
            console.log('üîµ About to show modal, current display:', modal.style.display);
            modal.style.display = 'flex';
            console.log('üîµ Modal display set to:', modal.style.display);
        }

        function closeCategoryView() {
            document.getElementById('category-products-modal').style.display = 'none';
            currentCategoryFilter = '';
        }

        function filterCategoryProducts() {
            const query = document.getElementById('category-search').value.toLowerCase();
            const categoryMap = {
                'unga': ['Unga'],
                'vinywaji': ['Vinywaji'],
                'maji': ['Maji'],
                'pipi': ['Pipi'],
                'vyakula': ['Vyakula'],
                'maziwa': ['Maziwa'],
                'watoto': ['Watoto'],
                'afya': ['Afya'],
                'steshenari': ['Steshenari'],
                'usafi': ['Usafi']
            };
            
            const productCategories = categoryMap[currentCategoryFilter] || [];
            const filtered = productCategories.length > 0 ? products.filter(p => productCategories.includes(p.category) && (p.name.toLowerCase().includes(query) || p.brand.toLowerCase().includes(query))) : [];
            
            const grid = document.getElementById('category-products-grid');
            grid.innerHTML = '';
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400 font-bold uppercase text-sm">Hakuna matokeo.</div>';
            } else {
                filtered.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'border border-gray-200 rounded-lg p-3 bg-white cursor-pointer hover:shadow-lg transition-shadow';
                    card.onclick = () => openProduct(product.id);
                    card.innerHTML = `
                        <img src="${product.img}" alt="${product.name}" class="w-full h-32 object-contain rounded mb-2 bg-gray-50" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        <h3 class="text-xs font-bold text-gray-900 line-clamp-1">${product.name}</h3>
                        <p class="text-[10px] text-gray-600 mb-2">${product.brand}</p>
                        <p class="text-red-600 font-black text-sm">TSH ${product.price.toLocaleString()}</p>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        function openProduct(id) {
        currentProduct = products.find(p => p.id === id);
        currentQty = 1;

        // 1. Update Image & Proportions
        const modalImg = document.getElementById('modal-img');
        modalImg.src = currentProduct.img;
        
        // Fallback if local photo is missing
        modalImg.onerror = function() {
            this.src = 'https://via.placeholder.com/600x400?text=Product+Image+Not+Found';
        };

        // 2. Update Text Content
        document.getElementById('modal-id').innerText = `SKU: ${currentProduct.id} | ${currentProduct.brand}`;
        document.getElementById('modal-name').innerText = currentProduct.name;
        document.getElementById('modal-price').innerText = `Tsh ${currentProduct.price.toLocaleString()}`;
        document.getElementById('modal-desc').innerText = currentProduct.desc;
        document.getElementById('modal-qty').innerText = currentQty;

        openPopup('product-modal');
    }

        function changeQty(amt) {
            currentQty = Math.max(1, currentQty + amt);
            document.getElementById('modal-qty').innerText = currentQty;
        }

        function confirmAddToCart() {
            const existing = cart.find(i => i.id === currentProduct.id);
            if(existing) existing.qty += currentQty;
            else cart.push({...currentProduct, qty: currentQty});
            closePopup('product-modal');
            updateCartUI();
        }

    function updateCartUI() {
    const trigger = document.getElementById('cart-trigger');
    const countEl = document.getElementById('cart-count');
    const itemsEl = document.getElementById('cart-items');
    const checkoutContent = document.getElementById('cart-checkout-content');

    const deliveryFee = 5000;

    if (cart.length === 0) {
        trigger.classList.add('hidden');
        itemsEl.innerHTML = '<p class="text-center text-gray-400 py-4 text-xs italic uppercase">Kapu lako halina bidhaa</p>';
        checkoutContent.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">Ongeza bidhaa kwenye kikapu</p>';
        return;
    }

    trigger.classList.remove('hidden');
    countEl.innerText = cart.reduce((s, i) => s + i.qty, 0);

    let subtotal = 0;
    itemsEl.innerHTML = cart.map((i, index) => {
        subtotal += (i.price * i.qty);
        return `
            <div class="flex justify-between items-center text-sm border-b border-gray-50 pb-3 mb-2">
                <div class="flex-grow">
                    <div class="font-bold text-gray-800">${i.name}</div>
                    <div class="text-[10px] text-gray-400 uppercase font-black">Qty: ${i.qty} | Tsh ${i.price.toLocaleString()} ea</div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-red-600 font-black text-right whitespace-nowrap">Tsh ${(i.price * i.qty).toLocaleString()}</div>
                    <button onclick="removeItem(${index})" class="text-gray-300 hover:text-red-600 transition p-1 text-lg" title="Ondoa">
                        üóëÔ∏è
                    </button>
                </div>
            </div>`;
    }).join('');

    // Final Grand Total (Subtotal + 5,000)
    const grandTotal = subtotal + deliveryFee;

    // Show different checkout options based on login status
    if (currentUser) {
        // User is logged in - show Supabase checkout
        checkoutContent.innerHTML = `
            <div class="space-y-3 mb-6">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3">Taarifa za Kufikia Kwa Inapo (Delivery)</p>
            </div>

            <div class="space-y-2 mb-4">
                <input type="text" id="delivery-name" placeholder="Jina lako" 
                    class="w-full border-2 border-gray-200 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                <input type="tel" id="delivery-phone" placeholder="Namba ya Simu (255...)" 
                    class="w-full border-2 border-gray-200 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                <button type="button" id="get-location-btn" 
                    class="w-full bg-red-600 text-white p-3 rounded-sm text-sm font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                    üìç Chukua Mahali Yangu (Get My Location)
                </button>
                <div id="location-display" class="text-xs text-gray-600 text-center hidden">
                    <span id="location-status">Mahali umechukuwa ‚úì</span>
                </div>
                <input type="hidden" id="delivery-latitude">
                <input type="hidden" id="delivery-longitude">
                <textarea id="delivery-notes" placeholder="Maelezo zaidi (Si lazima)" 
                    class="w-full border-2 border-gray-200 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors" rows="2"></textarea>
            </div>

            <div class="space-y-2 mb-4 border-b-2 border-dashed pb-4">
                <div class="flex justify-between text-xs font-bold text-gray-500 uppercase">
                    <span>Thamani ya Bidhaa:</span>
                    <span>Tsh ${subtotal.toLocaleString()}</span>
                </div>
                <div class="flex justify-between text-xs font-black text-red-600 uppercase">
                    <span>Nauli (Popote Dar):</span>
                    <span>Tsh ${deliveryFee.toLocaleString()}</span>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <span class="text-sm font-black text-gray-800 uppercase italic">Jumla Kuu:</span>
                <span class="text-2xl font-black text-gray-900 tracking-tighter">Tsh ${grandTotal.toLocaleString()}</span>
            </div>

            <div class="space-y-3 mb-6">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Chagua Njia ya Kulipwa</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-600 transition">
                        <input type="radio" name="payment-method" value="mpesa" class="payment-method-radio" checked>
                        <span class="ml-2 text-xs font-bold">üü¢ M-Pesa</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-600 transition">
                        <input type="radio" name="payment-method" value="airtel" class="payment-method-radio">
                        <span class="ml-2 text-xs font-bold">üî¥ Airtel</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-600 transition">
                        <input type="radio" name="payment-method" value="tigopesa" class="payment-method-radio">
                        <span class="ml-2 text-xs font-bold">üü° Tigo Pesa</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-600 transition">
                        <input type="radio" name="payment-method" value="halopesa" class="payment-method-radio">
                        <span class="ml-2 text-xs font-bold">üü£ Halo Pesa</span>
                    </label>
                </div>
            </div>

            <button onclick="processPayment()" class="w-full bg-red-600 text-white py-5 rounded-lg font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition flex items-center justify-center gap-2 hover:bg-red-700">
                <span>üí≥ Lipa Kwa Simu</span>
            </button>
            
            <button onclick="closePopup('cart-modal')" class="w-full text-center text-[10px] font-black text-gray-400 uppercase mt-5 tracking-widest hover:text-red-600 transition">
                ‚Üê Ongeza Bidhaa Nyingine
            </button>
        `;
    } else {
        // User not logged in - show WhatsApp checkout or login prompt
        checkoutContent.innerHTML = `
            <div class="space-y-3 mb-6">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Jinsi ya Kuagiza</p>
                <p class="text-xs text-gray-600 mb-3">Jisajili au ingia kwa akaunti ili kuagiza moja kwa moja</p>
                
                <button onclick="switchToLoginFromCart()" class="w-full bg-blue-600 text-white py-3 rounded-sm font-black uppercase tracking-widest text-xs hover:bg-blue-700 transition mb-2">
                    üîì Ingia / Jisajili
                </button>

                <p class="text-xs text-gray-600 text-center py-2">Au</p>

                <input type="tel" id="cust-phone" placeholder="Namba yako ya Simu" 
                    class="w-full border-2 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                <input type="text" id="cust-name" placeholder="Jina lako (Mfano: Simba)" 
                    class="w-full border-2 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
                <input type="text" id="cust-loc" placeholder="Mahali (Mtaa/Jengo)" 
                    class="w-full border-2 p-3 rounded-sm text-sm font-bold focus:border-red-600 outline-none transition-colors">
            </div>

            <div class="space-y-2 mb-4 border-b-2 border-dashed pb-4">
                <div class="flex justify-between text-xs font-bold text-gray-500 uppercase">
                    <span>Thamani ya Bidhaa:</span>
                    <span>Tsh ${subtotal.toLocaleString()}</span>
                </div>
                <div class="flex justify-between text-xs font-black text-red-600 uppercase">
                    <span>Nauli (Popote Dar):</span>
                    <span>Tsh ${deliveryFee.toLocaleString()}</span>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <span class="text-sm font-black text-gray-800 uppercase italic">Jumla Kuu:</span>
                <span class="text-2xl font-black text-gray-900 tracking-tighter">Tsh ${grandTotal.toLocaleString()}</span>
            </div>

            <button onclick="sendWhatsApp()" class="w-full bg-green-600 text-white py-5 rounded-lg font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition flex items-center justify-center gap-2">
                <span>üí¨ Thibitisha Oda WhatsApp</span>
            </button>
            
            <button onclick="closePopup('cart-modal')" class="w-full text-center text-[10px] font-black text-gray-400 uppercase mt-5 tracking-widest hover:text-red-600 transition">
                ‚Üê Ongeza Bidhaa Nyingine
            </button>
        `;
    }
}
        function removeItem(index) {
            // Remove the item from the array
            cart.splice(index, 1);
            
            // Refresh the UI to show the updated list
            updateCartUI();
            
            // If the cart becomes empty after removal, close the modal
            if (cart.length === 0) {
                setTimeout(() => {
                    closePopup('cart-modal');
                }, 300);
            }
        }

        // Switch to login from cart
        function switchToLoginFromCart() {
            closePopup('cart-modal');
            openPopup('login-modal');
        }

        // ============================================
        // SUPABASE ORDER SUBMISSION
        // ============================================
        async function submitOrderToSupabase() {
            if (!currentUser) {
                alert('Tafadhali ingia kwa akaunti kwanza!');
                return;
            }

            if (cart.length === 0) {
                alert('Kapu lako halina bidhaa!');
                return;
            }

            // Get delivery information
            const deliveryName = document.getElementById('delivery-name').value.trim();
            const deliveryPhone = document.getElementById('delivery-phone').value.trim();
            const deliveryLatitude = parseFloat(document.getElementById('delivery-latitude').value);
            const deliveryLongitude = parseFloat(document.getElementById('delivery-longitude').value);
            const deliveryNotes = document.getElementById('delivery-notes').value.trim();

            // Validate required fields
            if (!deliveryName || !deliveryPhone || !deliveryLatitude || !deliveryLongitude) {
                alert('Tafadhali jaza: Jina, Namba ya Simu, na Mahali (chukua GPS)!');
                return;
            }

            try {
                const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
                const deliveryFee = 5000;
                const grandTotal = subtotal + deliveryFee;

                // Prepare order items
                const orderItems = cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.qty,
                    unit_price: item.price,
                    total_price: item.price * item.qty
                }));

                // Insert order into Supabase with delivery info
                const { data, error } = await supabaseClient
                    .from('orders')
                    .insert([{
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        customer_name: deliveryName,
                        customer_phone: deliveryPhone,
                        delivery_latitude: deliveryLatitude,
                        delivery_longitude: deliveryLongitude,
                        delivery_notes: deliveryNotes,
                        order_items: orderItems,
                        subtotal: subtotal,
                        delivery_fee: deliveryFee,
                        total_amount: grandTotal,
                        order_status: 'pending',
                        created_at: new Date(),
                    }]);

                if (error) {
                    console.error('Order submission error:', error);
                    alert('Kosa katika kuagiza: ' + error.message);
                    return;
                }

                // Show success message
                const toast = document.getElementById("success-toast");
                toast.className = "show";

                setTimeout(() => {
                    toast.className = toast.className.replace("show", "");
                    cart = [];
                    updateCartUI();
                    closePopup('cart-modal');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 3000);

            } catch (error) {
                console.error('Order submission error:', error);
                alert('Kosa katika kuagiza: ' + error.message);
            }
        }

        // ============================================
        // PESAPAL PAYMENT GATEWAY INTEGRATION
        // ============================================

        // ============================================
        // PESAPAL V3 PAYMENT GATEWAY (SECURE BACKEND)
        // ============================================

        async function processPayment() {
            if (!currentUser) {
                alert('Tafadhali ingia kwa akaunti kwanza!');
                return;
            }

            if (cart.length === 0) {
                alert('Kapu lako halina bidhaa!');
                return;
            }

            // Get delivery information
            const deliveryName = document.getElementById('delivery-name')?.value.trim();
            const deliveryPhone = document.getElementById('delivery-phone')?.value.trim();
            const deliveryLatitude = parseFloat(document.getElementById('delivery-latitude')?.value);
            const deliveryLongitude = parseFloat(document.getElementById('delivery-longitude')?.value);

            if (!deliveryName || !deliveryPhone || !deliveryLatitude || !deliveryLongitude) {
                alert('Tafadhali jaza: Jina, Namba ya Simu, na Mahali (chukua GPS)!');
                return;
            }

            // Get selected payment method
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'mpesa';

            try {
                // Show loading indicator
                const paymentBtn = document.querySelector('button[onclick="processPayment()"]');
                if (paymentBtn) {
                    paymentBtn.disabled = true;
                    paymentBtn.textContent = '‚è≥ Chunguza Dirisha la Malipo...';
                }

                const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
                const deliveryFee = 5000;
                const grandTotal = subtotal + deliveryFee;

                // Create order items array
                const orderItems = cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.qty,
                    unit_price: item.price,
                    total_price: item.price * item.qty
                }));

                // Step 1: Create the order in Supabase with status 'awaiting_payment'
                const { data: orderData, error: orderError } = await supabaseClient
                    .from('orders')
                    .insert([{
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        customer_name: deliveryName,
                        customer_phone: deliveryPhone,
                        delivery_latitude: deliveryLatitude,
                        delivery_longitude: deliveryLongitude,
                        order_items: orderItems,
                        subtotal: subtotal,
                        delivery_fee: deliveryFee,
                        total_amount: grandTotal,
                        payment_method: paymentMethod,
                        order_status: 'awaiting_payment',
                        created_at: new Date(),
                    }])
                    .select();

                if (orderError) {
                    console.error('Order creation error:', orderError);
                    alert('Kosa katika kuandaa oda: ' + orderError.message);
                    if (paymentBtn) {
                        paymentBtn.disabled = false;
                        paymentBtn.textContent = 'üí≥ Lipa Kwa Simu';
                    }
                    return;
                }

                const orderId = orderData[0].id;
                console.log('[Payment] Order created:', orderId);

                // Step 2: Call backend API to submit order to Pesapal
                const submitResponse = await fetch('/api/pesapal/submit-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: grandTotal,
                        email: currentUser.email,
                        phone: deliveryPhone,
                        paymentMethod: paymentMethod,
                    }),
                });

                const submitData = await submitResponse.json();

                if (!submitData.success || !submitData.checkoutUrl) {
                    console.error('Pesapal submission error:', submitData);
                    alert('Kosa katika kuandaa malipo: ' + (submitData.error || 'Unknown error'));
                    if (paymentBtn) {
                        paymentBtn.disabled = false;
                        paymentBtn.textContent = 'üí≥ Lipa Kwa Simu';
                    }
                    return;
                }

                console.log('[Payment] Order submitted to Pesapal:', submitData.orderTrackingId);

                // Step 3: Save checkout URL for redirect
                localStorage.setItem('lastOrderId', orderId);
                localStorage.setItem('lastOrderTotal', grandTotal);

                // Step 4: Start polling for payment confirmation
                pollPaymentStatus(orderId);

                // Step 5: Redirect user to Pesapal checkout
                // Use small delay to ensure polling starts first
                setTimeout(() => {
                    window.location.href = submitData.checkoutUrl;
                }, 500);

            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Kosa katika kulipwa: ' + error.message);
                
                // Re-enable button
                const paymentBtn = document.querySelector('button[onclick="processPayment()"]');
                if (paymentBtn) {
                    paymentBtn.disabled = false;
                    paymentBtn.textContent = 'üí≥ Lipa Kwa Simu';
                }
            }
        }

        function pollPaymentStatus(orderId) {
            /**
             * Poll for payment confirmation
             * This is fallback - IPN webhook is authoritative
             * Polls for 2 minutes then gives up
             */
            let pollCount = 0;
            const maxPolls = 120; // 2 minutes at 1-second intervals

            const pollInterval = setInterval(async () => {
                pollCount++;

                try {
                    // Check order status in Supabase
                    const { data: order } = await supabaseClient
                        .from('orders')
                        .select('order_status')
                        .eq('id', orderId)
                        .single();

                    if (order?.order_status === 'paid') {
                        clearInterval(pollInterval);
                        console.log('[Payment] Order marked as PAID');
                        showPaymentSuccess(orderId);
                        return;
                    }

                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        console.log('[Payment] Polling timeout - IPN will confirm payment');
                    }

                } catch (error) {
                    console.error('Error polling payment status:', error);
                }
            }, 1000);
        }

        function showPaymentSuccess(orderId) {
            const toast = document.getElementById("success-toast");
            if (toast) {
                toast.textContent = '‚úÖ Malipo yamefanikiwa! Oda iko katika mlangoni.';
                toast.className = "show";
            }

            setTimeout(() => {
                if (toast) toast.className = toast.className.replace("show", "");
                cart = [];
                updateCartUI();
                closePopup('cart-modal');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 3000);
        }

        function toggleCartShortcut() {
            if (cart.length === 0) {
                alert("Ongeza bidhaa kwenye kikapu kwanza.");
                window.scrollTo({ top: document.getElementById('product-search').offsetTop - 100, behavior: 'smooth' });
            } else {
                openPopup('cart-modal');
            }
        }

        // ============================================
        // GEOLOCATION HANDLER
        // ============================================
        function setupLocationButton() {
            const getLocationBtn = document.getElementById('get-location-btn');
            if (!getLocationBtn) return;

            getLocationBtn.addEventListener('click', function() {
                getLocationBtn.disabled = true;
                getLocationBtn.textContent = '‚è≥ Chunguza...';

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            document.getElementById('delivery-latitude').value = lat;
                            document.getElementById('delivery-longitude').value = lng;
                            
                            const locationDisplay = document.getElementById('location-display');
                            locationDisplay.classList.remove('hidden');
                            document.getElementById('location-status').textContent = 
                                `‚úì ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                            
                            getLocationBtn.textContent = 'üìç Mahali Umechukuwa ‚úì';
                            getLocationBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                            getLocationBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        },
                        function(error) {
                            console.error('Geolocation error:', error);
                            alert('Kapu haiwezi kupata mahali. Tafadhali hakikisha kwamba umekuwa na ruhusa ya GPS.');
                            getLocationBtn.disabled = false;
                            getLocationBtn.textContent = 'üìç Chukua Mahali Yangu (Get My Location)';
                        }
                    );
                } else {
                    alert('Kapu lako haina uwezo wa GPS.');
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'üìç Chukua Mahali Yangu (Get My Location)';
                }
            });
        }

        function sendWhatsApp() {
    const phone = document.getElementById('cust-phone').value;
    const name = document.getElementById('cust-name').value;
    const loc = document.getElementById('cust-loc').value;
    
    // 1. Validation: Ensure all fields are filled
    if(!phone || !name || !loc) {
        return alert("Tafadhali jaza namba, jina, na mahali unapatikana!");
    }
    
    // 2. Calculate Costs
    const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const deliveryFee = 5000;
    const grandTotal = subtotal + deliveryFee;

    // 3. Generate Item List
    const itemsTxt = cart.map(i => `‚Ä¢ ${i.name} (Qty: ${i.qty})`).join('%0A');
    
    // 4. WhatsApp Message with Transparent Billing
    const msg = `*MZIGO MPYA - SIMBA EXPRESS*%0A%0A` +
                `*Mteja:* ${name}%0A` +
                `*Simu:* ${phone}%0A` +
                `*Mahali:* ${loc}%0A%0A` +
                `*Vitu Alivyochagua:*%0A${itemsTxt}%0A%0A` +
                `---------------------------%0A` +
                `*Thamani ya Bidhaa:* Tsh ${subtotal.toLocaleString()}%0A` +
                `*Nauli (Popote Dar):* Tsh ${deliveryFee.toLocaleString()}%0A` +
                `*JUMLA KUU:* Tsh ${grandTotal.toLocaleString()}%0A` +
                `---------------------------%0A` +
                `_Malipo ni baada ya mzigo kufika._%0A` +
                `_Mzigo utafika ndani ya dakika 60._`;
    
    // 5. Open WhatsApp
    window.location.href = `https://wa.me/255685636220?text=${msg}`;

    // 6. Show Success Toast and Reset
    const toast = document.getElementById("success-toast");
    toast.className = "show";

    setTimeout(() => {
        toast.className = toast.className.replace("show", "");
        cart = []; 
        document.getElementById('cust-phone').value = '';
        document.getElementById('cust-name').value = '';
        document.getElementById('cust-loc').value = '';
        updateCartUI(); 
        closePopup('cart-modal'); 
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 3000);
}

        // Slider Functions
        let currentSlide = 0;
        const totalSlides = 2;
        let autoSlideInterval;

        function showSlide(n) {
            const slides = document.querySelectorAll('.hero-slider-item');
            const dots = document.querySelectorAll('.slider-dot');
            
            if (n >= totalSlides) currentSlide = 0;
            if (n < 0) currentSlide = totalSlides - 1;
            
            slides.forEach(slide => {
                slide.classList.add('hidden');
                slide.classList.remove('active');
            });
            dots.forEach(dot => dot.classList.remove('active'));
            
            slides[currentSlide].classList.remove('hidden');
            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');
        }

        function nextSlide() {
            currentSlide++;
            showSlide(currentSlide);
            resetAutoSlide();
        }

        function prevSlide() {
            currentSlide--;
            showSlide(currentSlide);
            resetAutoSlide();
        }

        function goToSlide(n) {
            currentSlide = n;
            showSlide(currentSlide);
            resetAutoSlide();
        }

        function autoSlide() {
            currentSlide++;
            if (currentSlide >= totalSlides) currentSlide = 0;
            showSlide(currentSlide);
        }

        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            autoSlideInterval = setInterval(autoSlide, 5000);
        }

        function openPopup(id) { 
            document.getElementById(id).classList.add('active'); 
            // Setup location button when cart modal is opened
            if (id === 'cart-modal') {
                setTimeout(() => setupLocationButton(), 100);
            }
        }
        function closePopup(id) { document.getElementById(id).classList.remove('active'); }

        window.onload = async () => {
            console.log('Page loaded, starting initialization...');
            console.log('Total products loaded:', products.length);
            console.log('Product categories:', [...new Set(products.map(p => p.category))]);
            
            checkUserSession();
            // Try to load products from Supabase, fallback to local products
            await loadProductsFromSupabase();
            
            console.log('After Supabase load - Products count:', products.length);
            console.log('Product categories:', [...new Set(products.map(p => p.category))]);
            
            renderGrid(products);
            // Start auto-slide
            autoSlideInterval = setInterval(autoSlide, 5000);
        };
    </script>
</body>
</html>